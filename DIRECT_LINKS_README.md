# Настройка прямых ссылок для Video Downloader Bot

Данная инструкция описывает процесс настройки возможности скачивания видео через прямые ссылки, когда файлы слишком большие для отправки через Telegram (>50 МБ).

## Список файлов

- `link_generator.py` - Модуль для генерации и управления прямыми ссылками
- `nginx-dl.rox.su.conf` - Конфигурация Nginx для домена dl.rox.su
- `setup-ssl.sh` - Скрипт для настройки SSL-сертификатов
- `404.html`, `50x.html`, `index.html` - Страницы ошибок и индексная страница

## Шаги по настройке

### 1. Подготовка сервера

1. Установите Nginx и необходимые зависимости:

   ```bash
   sudo apt update
   sudo apt install -y nginx certbot python3-certbot-nginx
   ```

2. Настройте DNS-записи для домена dl.rox.su, указав на IP-адрес вашего сервера.

### 2. Настройка директории для хранения файлов

1. Создайте директорию для хранения загруженных файлов:

   ```bash
   mkdir -p downloads/shared
   chmod 755 downloads/shared
   ```

### 3. Настройка SSL-сертификатов

1. Сделайте скрипт setup-ssl.sh исполняемым:

   ```bash
   chmod +x setup-ssl.sh
   ```

2. Запустите скрипт с правами администратора:

   ```bash
   sudo ./setup-ssl.sh
   ```

3. Скрипт автоматически выполнит следующие действия:
   - Установит Certbot, если он отсутствует
   - Настроит Nginx для валидации домена
   - Получит SSL-сертификаты от Let's Encrypt
   - Настроит автоматическое обновление сертификатов
   - Применит полную конфигурацию Nginx

### 4. Настройка статических файлов

1. Создайте директорию для статических файлов:

   ```bash
   sudo mkdir -p /var/www/html
   ```

2. Скопируйте файлы 404.html, 50x.html и index.html:

   ```bash
   sudo cp 404.html 50x.html index.html /var/www/html/
   ```

3. Установите правильные права:

   ```bash
   sudo chown -R www-data:www-data /var/www/html
   sudo chmod -R 755 /var/www/html
   ```

### 5. Обновление кода бота

1. Убедитесь, что все файлы Python добавлены в проект:
   - `link_generator.py` должен находиться в корневой директории проекта

2. Обновите config.py, добавив настройки для прямых ссылок (уже сделано)

3. Обновите locales/ru.json с новыми сообщениями (уже сделано)

### 6. Проверка и мониторинг

1. Перезапустите бота:

   ```bash
   python bot.py
   ```

2. Проверьте доступность вашего сервера:

   ```bash
   curl -I https://dl.rox.su
   ```

3. Отправьте боту ссылку на большое видео (>50 МБ) и убедитесь, что опция "Получить прямую ссылку" работает корректно.

4. Просмотреть логи Nginx для отладки:

   ```bash
   sudo tail -f /var/log/nginx/access.log
   sudo tail -f /var/log/nginx/error.log
   ```

## Техническое обслуживание

### Обновление сертификатов

Сертификаты Let's Encrypt обновляются автоматически через cron. Вы можете вручную запустить обновление:

```bash
sudo certbot renew
```

### Мониторинг использования диска

Регулярно проверяйте использование диска:

```bash
du -sh downloads/shared
```

### Ручная очистка устаревших файлов

В случае необходимости вы можете вручную запустить очистку устаревших файлов:

```bash
python -c "import asyncio; from link_generator import LinkGenerator; asyncio.run(LinkGenerator().cleanup_expired_links())"
```

## Проблемы и их решение

### Ошибка "Permission denied"

Если возникают ошибки доступа к директории с файлами:

```bash
sudo chown -R your_user:your_group downloads/shared
chmod -R 755 downloads/shared
```

### Проблемы с Nginx

Проверьте конфигурацию Nginx:

```bash
sudo nginx -t
```

### Сертификаты не обновляются

Проверьте наличие задачи в cron:

```bash
sudo cat /etc/crontab | grep certbot
```

## Дополнительная информация

### Структура директории shared

Каждый файл в директории shared имеет соответствующий .meta файл, содержащий метаданные:
- Оригинальное имя файла
- Срок истечения
- Путь к исходному файлу
- Дата создания

### Безопасность

Настройки Nginx блокируют доступ к .meta файлам и предотвращают индексацию директории.

### Производительность

Конфигурация Nginx оптимизирована для работы с большими файлами, включая настройки буферизации и таймаутов. 